# Local Firmware Build Guide

This guide explains how to compile the ZSA Voyager firmware locally using Docker.

## ⚠️ Known Issue: rgb_matrix_kb.inc Error

**Current Status**: Local Docker builds are experiencing a compilation error with `rgb_matrix_kb.inc: No such file or directory`. This file is generated by the ZSA modules system during the build process.

**Workaround**: Use the GitHub Actions workflow which has the proper infrastructure to generate this file automatically.

**Recommended Build Method**: See "Building via GitHub Actions" section below.

---

## Prerequisites

- **Docker Desktop** installed and running
  - Windows: [Download Docker Desktop](https://www.docker.com/products/docker-desktop/)
  - macOS: [Download Docker Desktop](https://www.docker.com/products/docker-desktop/)
  - Linux: [Install Docker Engine](https://docs.docker.com/engine/install/)

## Quick Start

### Windows (PowerShell)

```powershell
# Build firmware for vrMEr keymap
.\build-firmware.ps1

# Build with clean slate
.\build-firmware.ps1 -Clean

# Build different keymap
.\build-firmware.ps1 -KeymapDir JRaem
```

### Linux/macOS (Bash)

```bash
# Make script executable (first time only)
chmod +x build-firmware.sh

# Build firmware for vrMEr keymap
./build-firmware.sh

# Build with clean slate
./build-firmware.sh --clean

# Build different keymap
./build-firmware.sh JRaem
```

## What Happens During Build

1. **Docker Image Check**: Verifies `qmk-builder` image exists, builds it if needed
2. **QMK Firmware Clone**: Downloads fresh ZSA QMK firmware (first run takes longer)
3. **Keymap Copy**: Copies your keymap directory to the QMK firmware tree
4. **Compilation**: Runs `make zsa/voyager:<keymap>` to build the firmware
5. **Output**: Creates `.bin` file and `build.log` in the project root

## Build Artifacts

After successful build:

- **`zsa_voyager_<keymap>.bin`** - Firmware file ready to flash
- **`build.log`** - Complete build log for debugging

## Firmware Size Target

The ZSA Voyager has 256KB flash memory. The target is to keep firmware under **230KB** (90% capacity) to ensure stability.

The build script will automatically:
- ✓ Report firmware size in KB and percentage
- ✓ Warn if size exceeds 230KB target

## Flashing Firmware

After successful build, flash the firmware using:

**Keymapp Application** (Recommended)
1. Download from [https://www.zsa.io/flash](https://www.zsa.io/flash)
2. Connect your keyboard
3. Select the `.bin` file
4. Follow on-screen instructions

## Troubleshooting

### Docker Image Build Fails

```powershell
# Rebuild Docker image from scratch
docker build --no-cache -t qmk-builder .
```

### Compilation Errors

1. Check `build.log` for detailed error messages
2. Verify keymap files have no syntax errors:
   - `config.h`
   - `keymap.c`
   - `rules.mk`
   - `i18n.h`

### No .bin File Generated

```powershell
# Check build log for errors
Get-Content build.log | Select-String -Pattern "error"

# On Linux/macOS
grep -i error build.log
```

### Docker Not Running

**Windows/macOS**: Start Docker Desktop application

**Linux**:
```bash
sudo systemctl start docker
```

## Manual Docker Build (Advanced)

If you prefer manual control:

```bash
# Build Docker image
docker build -t qmk-builder .

# Run compilation
docker run --rm -v "${PWD}:/workspace" qmk-builder bash -c "
  git clone --depth=1 --recurse-submodules https://github.com/zsa/qmk_firmware.git /qmk && \
  cd /qmk && \
  cp -r /workspace/vrMEr keyboards/zsa/voyager/keymaps/ && \
  make zsa/voyager:vrMEr 2>&1 | tee /workspace/build.log && \
  cp *.bin /workspace/
"
```

## Build Environment Details

The Docker container includes:
- Debian latest base image
- GCC for AVR (8-bit microcontrollers)
- GCC for ARM (32-bit microcontrollers - used by Voyager)
- QMK CLI tools
- Python 3 with QMK dependencies

## Comparing with GitHub Actions

**Local Build Advantages:**
- ✓ Faster iteration (no git push needed)
- ✓ Offline capability (after first QMK clone)
- ✓ Full build logs immediately available

**GitHub Actions Advantages:**
- ✓ Automatic builds on push
- ✓ Build artifacts stored in GitHub
- ✓ No local Docker setup needed

Both methods produce identical firmware binaries.

## Next Steps

After successful build:
1. Review firmware size (should be <230KB)
2. Flash to keyboard using Keymapp
3. Test all layers and functions
4. Refer to `vrMEr/LAYER_VISUALIZATION.md` for layout reference

## Support

- **QMK Documentation**: [https://docs.qmk.fm/](https://docs.qmk.fm/)
- **ZSA Support**: [https://www.zsa.io/support](https://www.zsa.io/support)
- **Docker Documentation**: [https://docs.docker.com/](https://docs.docker.com/)

---

## Building via GitHub Actions (Recommended)

Due to the `rgb_matrix_kb.inc` issue with local builds, using GitHub Actions is the recommended approach:

### Method 1: Automatic Build on Push

1. Make changes to your keymap files in `vrMEr/` (or `JRaem/`)
2. Commit and push to the `main` branch:
   ```bash
   git add vrMEr/*
   git commit -m "feat: Update keymap"
   git push origin main
   ```
3. Go to GitHub Actions tab
4. Run the "Fetch and build layout" workflow
5. Download the firmware from the workflow artifacts

### Method 2: Manual Workflow Trigger

1. Go to your repository on GitHub
2. Click the "Actions" tab
3. Select "Fetch and build layout" workflow
4. Click "Run workflow"
5. Wait for completion (usually 2-3 minutes)
6. Download the `.bin` file from artifacts

### Advantages of GitHub Actions

- ✅ No local Docker setup required
- ✅ Consistent build environment  
- ✅ Automatic artifact storage
- ✅ No rgb_matrix_kb.inc issues
- ✅ Build logs saved in GitHub

The GitHub Actions workflow is configured to:
- Clone the ZSA QMK firmware with all required modules
- Copy your keymap files
- Build the firmware with proper module initialization
- Upload the `.bin` file as an artifact
