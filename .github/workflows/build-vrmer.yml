name: Build vrMEr firmware

on:
  workflow_dispatch:
  push:
    branches:
      - 002-minimize-layers
    paths:
      - 'vrMEr/**'

permissions:
  contents: write

jobs:
  build-vrmer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t qmk-builder .

      - name: Clone QMK Firmware and Build
        id: build
        run: |
          docker run -v $PWD:/workspace --rm qmk-builder /bin/sh -c "
            git clone --depth=1 --recurse-submodules https://github.com/zsa/qmk_firmware.git /qmk
            cp -r /workspace/vrMEr /qmk/keyboards/zsa/voyager/keymaps/
            cd /qmk
            make zsa/voyager:vrMEr
            cp *.bin /workspace/ 2>/dev/null || true
          "
          
          # Find the built firmware file
          firmware_file=$(find . -maxdepth 1 -type f -name "*voyager*vrMEr*.bin" | head -1)
          if [ -f "${firmware_file}" ]; then
            echo "firmware_file=${firmware_file}" >> "$GITHUB_OUTPUT"
            size=$(stat -c%s "${firmware_file}")
            size_kb=$((size / 1024))
            echo "firmware_size_kb=${size_kb}" >> "$GITHUB_OUTPUT"
            echo "âœ… Firmware built: ${firmware_file} (${size_kb} KB)"
            
            # Check if under 230KB target
            if [ ${size_kb} -lt 230 ]; then
              echo "âœ… Size target met: ${size_kb} KB < 230 KB"
            else
              echo "âš ï¸ Size over target: ${size_kb} KB >= 230 KB"
            fi
          else
            echo "âŒ No firmware file found"
            exit 1
          fi

      - name: Upload firmware artifact
        if: steps.build.outputs.firmware_file
        uses: actions/upload-artifact@v4
        with:
          name: voyager_vrMEr_firmware
          path: ${{ steps.build.outputs.firmware_file }}

      - name: Comment firmware size
        if: steps.build.outputs.firmware_size_kb
        run: |
          echo "ðŸ“¦ Firmware Size: ${{ steps.build.outputs.firmware_size_kb }} KB" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Target: < 230 KB" >> $GITHUB_STEP_SUMMARY
          if [ ${{ steps.build.outputs.firmware_size_kb }} -lt 230 ]; then
            echo "âœ… Size target MET!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Size EXCEEDS target by $((${{ steps.build.outputs.firmware_size_kb }} - 230)) KB" >> $GITHUB_STEP_SUMMARY
          fi
